# On-chain Identity Scoring System for Astar Network with Subsquid

![Dashboard](./doc/dashboard.png)

## Overview

æœ¬ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã¯ Astar x Slash Bounty Bootcamp Hackathon ã«å‘ã‘ã¦é–‹ç™ºã•ã‚ŒãŸ On-chain Identity Scoring System ã§ã™ã€‚
æœ¬ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã¯ä»¥ä¸‹ã®ç‰¹å¾´ã‚’æŒã¡ã¾ã™ã€‚

* ãƒ¦ãƒ¼ã‚¶ã¯ MetaMask ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é€£æºã—ã€Astar Network ä¸Šã§ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã«åŸºã¥ããƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚„ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤ºã™ã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–²è¦§ã§ãã¾ã™
* ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯ Next.js ãŠã‚ˆã³ Grafana ã‚’åˆ©ç”¨ã—ã¦é–‹ç™ºã•ã‚Œã¦ãŠã‚Šã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ã§è¡¨ç¾åŠ›ã«å„ªã‚ŒãŸãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç’°å¢ƒã‚’æä¾›ã—ã¾ã™
* ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã«ç”¨ã„ã‚‰ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ Subsquid indexer ãŠã‚ˆã³ web3.js ã‚’åˆ©ç”¨ã—ã¦åé›†ãƒ»è“„ç©ã•ã‚Œã¾ã™
* ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã«ã¯ IaC (Infrastructure as Code) ã‚„ AWS ã®ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§é‹ç”¨è² è·ã‚’è»½æ¸›ã—ã€å°†æ¥çš„ãªæ©Ÿèƒ½æ‹¡å¼µã‚„åˆ©ç”¨è€…ã®å¢—åŠ ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ‹¡å¤§ã«ã‚‚å¯¾å¿œå¯èƒ½ã§ã™

## Scoring Systems

æœ¬ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã¯ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

1. `Trader Score`ï¼šãƒ¦ãƒ¼ã‚¶ãŒé€£æºã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã«åŸºã¥ã„ã¦ã€æœŸé–“ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¹³å‡é€é‡‘é¡ã‚’ã‚¹ã‚³ã‚¢ã¨ã—ã¦è¡¨ç¤ºã—ã¾ã™
2. `Last Block Number`: ãƒ¦ãƒ¼ã‚¶ãŒé€£æºã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã«åŸºã¥ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãŒé–¢ã‚ã£ãŸæœ€å¾Œã®ãƒ–ãƒ­ãƒƒã‚¯ç•ªå·ã‚’è¡¨ç¤ºã—ã¾ã™

ã¾ãŸæœ¬ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã¯æ›´ãªã‚‹æ©Ÿèƒ½æ‹¡å¼µã®ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãª Astar Network å…¨ä½“ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

1. `Top10 Token Activities`: ãƒã‚§ãƒ¼ãƒ³å…¨ä½“ã§æœ€ã‚‚ã‚„ã‚Šã¨ã‚Šã•ã‚Œã¦ã„ã‚‹ Top10 ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¸ã® wei é€ä¿¡é‡ã‚’è¡¨ã™ TimeLine ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã—ã¾ã™
2. `Token Based User Ranking`: ç‰¹å®šã¾ãŸã¯ã™ã¹ã¦ã®ãƒˆãƒ¼ã‚¯ãƒ³ã«ãŠã„ã¦ã€ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¸ã®é€ä¿¡é‡ãŒæœ€ã‚‚å¤šã„ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ©ãƒ³ã‚­ãƒ³ã‚°å½¢å¼ã§è¡¨ç¤ºã—ã¾ã™
3. `Total Transfer Sum` : ãƒã‚§ãƒ¼ãƒ³å…¨ä½“ã«ãŠã„ã¦ã€ç‰¹å®šæœŸé–“ä¸­ã®ãƒˆãƒ¼ã‚¯ãƒ³é€ä¿¡é‡ã® TimeLine ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã—ã¾ã™

## Architecture

æœ¬ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ä»¥ä¸‹ã®å›³ã«ç¤ºã—ã¾ã™ã€‚
å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è©³ç´°ã¯ [Design Considerations](#design-considerations) ã«è¨˜è¼‰ã—ã¾ã™ã€‚

![Architecture](./doc/architecture.png)

## Design Considerations

æœ¬ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã¯å¤§ããåˆ†ã‘ã¦ MetaMask ã‚’é€£æºã—ãŸãƒ¦ãƒ¼ã‚¶ã®ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°çµæœã‚’è¡¨ç¤ºã™ã‚‹ Frontend ã¨ã€Subsquid indexer ã‚’é€šã—ã¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã«åˆ©ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã™ã‚‹ Squid Processor ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚

æœ¬ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã¯ IaC ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹ [AWS CDK](https://aws.amazon.com/jp/cdk/) ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã£ã¦æœ¬ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®é€Ÿã‚„ã‹ãªãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å¯èƒ½ã¨ã—ã€ã¾ãŸä»–ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ã®åˆ©ç”¨ã‚„æ©Ÿèƒ½è¿½åŠ ãªã©ã«å¯¾ã™ã‚‹é«˜ã„å†åˆ©ç”¨æ€§ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã€ãã—ã¦æ‹¡å¼µæ€§ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

### Frontend

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯ Fargate ä¸Šã§å‹•ä½œã™ã‚‹ Next.js ã«ã‚ˆã£ã¦æä¾›ã•ã‚Œã¾ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ã®å¢—æ¸›ã«å¿œã˜ã¦èµ·å‹•ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠæ•°ã¯è‡ªå‹•çš„ã«ã‚¹ã‚±ãƒ¼ãƒ«ã—ã€å°†æ¥çš„ãªãƒ¦ãƒ¼ã‚¶æ•°ã®å¢—åŠ ã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãŒé–²è¦§ã™ã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯åŒã˜ã Fargate ä¸Šã§å‹•ä½œã™ã‚‹ Grafana ã«ã‚ˆã£ã¦æä¾›ã•ã‚Œã¾ã™ã€‚
Grafana ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ Amazon OpenSearch Service ã«æ¥ç¶šã•ã‚Œã¦ãŠã‚Šã€å‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆãƒ»å–å¾—ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚
ã‚¯ã‚¨ãƒªã‚„æ ¼ç´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦å¤šæ§˜ãªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å®Ÿè£…ã€æ‹¡å¼µã§ãã¾ã™ã€‚
Grafana å˜ä½“ã§ã‚‚æœ¬ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®é‹ç”¨è€…ãŒ Astar Network ä¸Šã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®åˆ†æåŸºç›¤ã¨ã—ã¦ã‚‚å¿œç”¨å¯èƒ½ã§ã™ã€‚

### Subsquid Processor

æœ¬ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã«åˆ©ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ Subsquid ã® [Substrate Processor](https://docs.subsquid.io/substrate-indexing/) ãŠã‚ˆã³ web3.js ã‚’åˆ©ç”¨ã—ã¦åé›†ã—ã¾ã™ (ä»¥å¾Œã€Processor ã¨å‘¼ç§°)ã€‚
Processor ã¯ EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã§å‹•ä½œã—ã€`approve` ã‚„ `transfer` ã¨ã„ã£ãŸ call ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ãŸå¾Œã« web3.js ã‚’åˆ©ç”¨ã—ã¦å–å¾—ã—ãŸè£œåŠ©çš„ãªæƒ…å ±ã‚’ä»˜åŠ ã—ã€Amazon Kinesis Data Firehose ã‚’çµŒç”±ã—ã¦ Amazon OpenSearch Service ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã—ã¾ã™ã€‚

ç¾æ™‚ç‚¹ã§ã¯å‡¦ç†å¯¾è±¡ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ•°ãŒæ¯”è¼ƒçš„å°è¦æ¨¡ã‹ã¤å·®åˆ†ã‚‚é »ç¹ã«ã¯ç™ºç”Ÿã—ãªã„ãŸã‚ã€Processor ã¯å˜ä¸€ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã§å‹•ä½œã—ã¦ã„ã¾ã™ã€‚
ãƒ‡ãƒ¼ã‚¿æ ¼ç´å…ˆã¯ãƒ‡ãƒ¼ã‚¿é‡ã®å¢—åŠ ã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†è¨­è¨ˆã•ã‚Œã¦ãŠã‚Šã€Processor ã®è¿½åŠ ã«ã‚ˆã£ã¦ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ‹¡å¤§å¾Œã‚‚ç¨¼åƒå¯èƒ½ã§ã™ã€‚

## Deployment

### Prerequisites

ã¯ã˜ã‚ã«ã€AWS CDK ã‚’å®Ÿè¡Œã§ãã‚‹ç’°å¢ƒã‚’ç”¨æ„ã—ã¦ãã ã•ã„ã€‚
ã“ã‚Œã¯ã€ä»¥ä¸‹ã®æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

* å¿…è¦ãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨
  * [Node.js](https://nodejs.org/en/download/)
    * v16 ä»¥ä¸Šã‚’æ¨å¥¨
    * `node -v` ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã¾ã™
  * [AWS CLI](https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/getting-started-install.html)
    * v2 ã‚’æ¨å¥¨
    * `aws --version` ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã¾ã™
  * docker
    * [Docker Desktop](https://docs.docker.com/desktop/install/mac-install/) ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æ¨å¥¨ã—ã¾ã™
* AWS CLI ã«é©åˆ‡ãª AWS IAM æ¨©é™ (Administrator ç›¸å½“ãŒå¿…è¦) ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
  * IAM ãƒ­ãƒ¼ãƒ«ã®è¨­å®šã‚’ã™ã‚‹ã‹ã€ `aws configure` ã‚³ãƒãƒ³ãƒ‰ã§ IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
  * [ã“ã¡ã‚‰ã®ãƒšãƒ¼ã‚¸](https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/cli-configure-files.html) ã‚’ã”å‚è€ƒã«ã—ã¦ãã ã•ã„

### Getting Started

ã¯ã˜ã‚ã«ã€ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³åã‚’ `cdk/bin/cdk.ts` ã® `region` ã«è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã¯ `us-east-1` ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆã®è¨˜å…¥ä¾‹ã§ã™ã€‚

```typescript
const env: cdk.Environment = { region: 'us-east-1' };
```

æœ¬ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (`README.md` ã®ã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™) ç›´ä¸‹ã® `/cdk` ã«ç§»å‹•ã—ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```sh
# Node ã®ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
npm ci
# ã”åˆ©ç”¨ã® AWS ç’°å¢ƒã§ CDK ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¾ã™
npx cdk bootstrap
```

`npm ci` ã¯ã€Node ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚åˆå›ã®ã¿å¿…è¦ã§ã™ã€‚

`cdk bootstrap` ã¯ã€ã”åˆ©ç”¨ã®ç’°å¢ƒã§ CDK ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«åˆæœŸè¨­å®šã‚’ãŠã“ãªã„ã¾ã™ã€‚
ã“ã¡ã‚‰ã¯ã‚ã‚‹ AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï½¥ã‚ã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§åˆã‚ã¦ CDK ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã«å¿…è¦ã§ã™ã€‚2 å›ç›®ä»¥é™ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚

âœ… `Environment aws://xxxx/us-east-1 bootstrapped` ã¨ã„ã†æ—¨ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°æˆåŠŸã§ã™ã€‚æ¬¡ã®æ‰‹é †ã«é€²ã‚“ã§ãã ã•ã„ã€‚

### Grafana ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ ã®ä½œæˆ

æœ€åˆã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®è¡¨ç¤ºã«ä½¿ç”¨ã™ã‚‹ Grafana ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚
`container/grafana` ä»¥ä¸‹ã§ä»¥ä¸‹ã®ä½œæ¥­ã‚’é †ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

1. [grafana.ini](./container/grafana/grafana.ini) ã‚’é–‹ãã€`admin_password` ã‚’å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ã¦ãã ã•ã„
    * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ `admin` ã§ã™
2. [create_grafana.sh](./container/grafana/create_grafana.sh) ã‚’å®Ÿè¡Œã—ã¾ã™
    * ãƒ­ãƒ¼ã‚«ãƒ«ã§ Grafana ç”¨ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¾ã™ã€‚

    ```sh
    cd container/grafana
    bash create_grafana.sh
    ```

3. [Grafana](http://localhost:3000) ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã€`username: admin`, `password: {ã”è‡ªèº«ã§è¨­å®šã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰}}` ã§ Grafana ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™
4. [API Key ä½œæˆãƒšãƒ¼ã‚¸](http://localhost:3000/org/apikeys) ã‚’é–‹ãã€æ–°ã—ã„ API Key ã‚’ä½œæˆã—ã¾ã™
    * `Key name` ã¯ä»»æ„ã®å€¤ã€`Role` ã¯ Editorã€`Time to Live` ã¯é©å½“ãªå€¤ (e.g. `1y`) ã‚’é¸æŠã—ã¦ãã ã•ã„
5. API Key ã®å€¤ã‚’ `bin/cdk.ts` ã® `grafana_api_key` ã«è¨˜å…¥ã—ã¦ãã ã•ã„
6. [push_to_ecr.sh](./container/grafana/push_to_ecr.sh) ã‚’å®Ÿè¡Œã—ã€API Key ç™ºè¡Œæ¸ˆã® Image ã‚’ä½œæˆã— ECR ã« Image ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã™
    * å¼•æ•°ã«ã¯ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚ä»¥ä¸‹ã«å®Ÿè¡Œä¾‹ã‚’è¨˜è¼‰ã—ã¾ã™

    ```sh
    bash push_to_ecr.sh us-east-1
    ```

ä»¥ä¸Šã§ Grafana ç”¨ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä½œæˆã¯å®Œäº†ã§ã™ã€‚

### Deployment Steps

CDK ã§ã‚¹ã‚¿ãƒƒã‚¯ç¾¤ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

1. OpenSearch Cluster ã®ãƒ‡ãƒ—ãƒ­ã‚¤
    * ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€OpenSearch Cluster ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™
    * `npx cdk deploy OpenSearchClusterStack`
2. OpenSearch Dashboard ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®è¨­å®š
    * [ã“ã¡ã‚‰ã®ãƒšãƒ¼ã‚¸](https://aws.amazon.com/jp/premiumsupport/knowledge-center/opensearch-troubleshoot-cloudwatch-logs/) ã®ã€€*ãã‚ç´°ã‹ãªã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å ´åˆã€CloudWatch ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ OpenSearch Service ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ããªã„* ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚è€ƒã«ã€Delivery Stream ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸ IAM ãƒ­ãƒ¼ãƒ«ã® ARN (`OpenSearchClusterStack` ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«è¡¨ç¤ºã•ã‚Œã¾ã™) ã«æ¨©é™ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
3. Subsquid Processor, ECS Cluster ã®ãƒ‡ãƒ—ãƒ­ã‚¤
    * ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€Subsquid Processor ã¨ ECS Cluster ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™
    * `npx cdk deploy OnchainScoringSystemStack`
4. Grafana ã®åˆæœŸè¨­å®š
    * Grafanaã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ `Configuration` ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€`Add data source` ã‚’é¸æŠã—ã¾ã™
    * Data source ã®ç¨®é¡ã¯ `OpenSearch` ã‚’é¸æŠã—ã€`OpenSearchClusterStack` ã® API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ URL ã‚’å…¥åŠ›ã—ã¾ã™ã€‚ï¼ˆData Sourceã®åå‰ã¯å¤‰æ›´ã—ãªã„ã§ãã ã•ã„ã€‚ï¼‰
    * åŒã˜è¨­å®šç”»é¢ã§ã€`Auth` ã®è¨­å®šã§ `Basic Auth` ã®ãƒˆã‚°ãƒ«ã‚’ On ã«ã—ã¾ã™ã€‚`Basic Auth Details` ã®é …ç›®ãŒå‡ºã‚‹ã®ã§ã€`User`, `Password` ã«ã¯ãã‚Œãã‚Œ Opensearch ã®ãƒ¦ãƒ¼ã‚¶åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
    * ã•ã‚‰ã«ä¸‹ã®é …ç›®ã§ `Index name` ã®æ¬„ã« `astar` ã‚’å…¥åŠ›ã—ã¾ã™ã€‚ãã®å¾Œ `Time field Stamp` ã®ä¸­èº« `@timestamp` ã‚’ `timestamp` ã«å¤‰æ›´ã—ã¾ã™
    * æœ€å¾Œã«ä¸€ç•ªä¸‹ã® `Save & test` ã‚’æŠ¼ã—ã€"Index OK. Time field name OK" ãŒè¡¨ç¤ºã•ã‚Œã‚Œã° Grafana ã® Data Source ã®æ¥ç¶šã¯å®Œäº†ã§ã™
    * ã“ã®æ™‚åŒã˜ç”»é¢ã§ãƒ–ãƒ©ã‚¦ã‚¶ã®URLæ¬„ã®æœ€å¾Œã® `/`ä»¥é™ã® UID ã‚’ãƒ¡ãƒ¢ã—ã¾ã™ã€‚(ä¾‹ï¼š`18ysFDbVk`)
    * ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ `./container/nextjs/next-app/pages/api/api-body` ä»¥ä¸‹ã® `.ts` ã§ data source ãƒ–ãƒ­ãƒƒã‚¯ã® `key:uid` ã®å€¤ã‚’ã™ã¹ã¦å…ˆã»ã©ãƒ¡ãƒ¢ã—ãŸã‚‚ã®ã«ç½®ãæ›ãˆã¾ã™ã€‚ä¾‹ï¼š`"uid": "7S_IFIb4z" -> "uid": "18ysFDbVk"`
    * ä»¥ä¸Šã§ Grafana ã®è¨­å®šã¯å®Œäº†ã§ã™
5. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®ã‚¢ã‚¯ã‚»ã‚¹
    * `FrontendServiceStack` ã®ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¢ã‚¯ã‚»ã‚¹å…ˆãŒå‡ºåŠ›ã•ã‚Œã¾ã™
    * ä¾‹: `OnchainScoringSystemStack.Web2ClusterNextjsServiceServiceURLXXXXXXXX = http://Oncha-Web2C-XXXXXXXXXXXXX-1234567890.us-east-1.elb.amazonaws.com`

### Clean up

ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹éš›ã¯ã€ä»¥ä¸‹ã® CDK ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:

```sh
npx cdk destroy --all
```

* `create_grafana.sh` ã§ä½œæˆã—ãŸ Grafana ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’[ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://console.aws.amazon.com/ecr/repositories) ã‹ã‚‰å‰Šé™¤ã—ã¦ãã ã•ã„

## FAQ

Q1:

A1:

## Related Contents

* [AKINDO On-chain Identity Scoring System](https://app.akindo.io/hackathons/mV8ExzgLGSlo8Zvd)
* [AstarÃ—Slash Bounty Bootcamp HackathonğŸ§‘ğŸ»â€ğŸ’»](https://akindo.notion.site/Astar-Slash-Bounty-Bootcamp-Hackathon-7133ffb059624bbd9d2ba079058ad1fc)
* [subsquid](https://docs.subsquid.io/)
* [squid-astar-example](https://github.com/subsquid/squid-astar-example)
